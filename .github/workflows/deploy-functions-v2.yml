
name: Déploiement des Functions v2
on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environnement de déploiement"
        required: true
        default: "production"
        type: choice
        options:
          - production
          - staging

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v3
      
      - name: Configuration de Node.js
        uses: ./.github/workflows/actions/setup-node
      
      - name: Vérification de l'installation de Node.js
        run: |
          node -v
          npm -v
      
      - name: Installation explicite de firebase-admin
        working-directory: functions-v2
        run: |
          rm -rf node_modules
          rm -f package-lock.json
          npm install firebase-admin --save --no-package-lock
          npm list firebase-admin --depth=0
          ls -la node_modules/firebase-admin
      
      - name: Installation des dépendances
        uses: ./.github/workflows/actions/install-dependencies
        with:
          working-directory: functions-v2
      
      - name: Vérification des dépendances installées
        working-directory: functions-v2
        run: |
          ls -la node_modules
          ls -la node_modules/firebase-admin || echo "firebase-admin non trouvé"
          npm list firebase-admin
          npm list firebase-functions
      
      - name: Configuration des variables d'environnement
        uses: ./.github/workflows/actions/setup-env
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          google-cloud-project: ${{ secrets.GOOGLE_CLOUD_PROJECT || 'calmi-99482' }}
          working-directory: functions-v2
      
      - name: Configuration du compte de service Firebase
        uses: ./.github/workflows/actions/setup-firebase-service
        with:
          firebase-service-account: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
      
      - name: Installation de Firebase CLI
        run: npm install -g firebase-tools@latest
      
      - name: Build des fonctions
        working-directory: functions-v2
        run: |
          npm run build
          echo "Contenu du dossier lib:"
          ls -la lib/
          
          # Copier package.json et node_modules dans lib
          cp package.json lib/
          mkdir -p lib/node_modules
          cp -r node_modules/firebase-admin lib/node_modules/
          cp -r node_modules/firebase-functions lib/node_modules/
      
      - name: Build et déploiement
        uses: ./.github/workflows/actions/build-deploy
        with:
          project-id: ${{ secrets.GOOGLE_CLOUD_PROJECT || 'calmi-99482' }}
          firebase-token: ${{ secrets.FIREBASE_TOKEN }}
          working-directory: functions-v2
          deploy-target: "functionsV2"
