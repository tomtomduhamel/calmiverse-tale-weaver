
name: D√©ploiement des Functions v2 Simplifi√©es
on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environnement de d√©ploiement"
        required: true
        default: "production"
        type: choice
        options:
          - production
          - staging

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v3
      
      - name: Configuration de Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
      
      - name: Installation compl√®te avec logs d√©taill√©s
        working-directory: functions-v2
        run: |
          echo "üì¢ D√©but de l'installation compl√®te avec logs d√©taill√©s"
          
          echo "üßπ Nettoyage des dossiers..."
          rm -rf node_modules lib
          
          echo "üì¶ Installation des d√©pendances avec logs..."
          npm install firebase-admin@13.0.2 firebase-functions@6.3.1 cors@2.8.5 --save
          
          echo "üìã V√©rification du package.json"
          cat package.json
          
          echo "üìã V√©rification des node_modules"
          ls -la node_modules | grep firebase
          ls -la node_modules/firebase-admin || echo "‚ùå firebase-admin NON TROUV√â!"
          
          echo "‚úÖ Installation termin√©e"
      
      - name: Configuration du compte de service Firebase
        uses: ./.github/workflows/actions/setup-firebase-service
        with:
          firebase-service-account: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
      
      - name: Installation de Firebase CLI
        run: npm install -g firebase-tools@13.0.2
      
      - name: D√©ploiement direct des Functions v2
        working-directory: functions-v2
        run: |
          echo "üöÄ D√©but du d√©ploiement des fonctions v2..."
          
          echo "üìÑ V√©rification de l'index.js avant d√©ploiement:"
          cat index.js
          
          echo "üìÑ V√©rification de package.json avant d√©ploiement:"
          cat package.json
          
          echo "üìÑ V√©rification de functions.yaml avant d√©ploiement:"
          cat functions.yaml
          
          echo "üîë Utilisation des variables d'environnement:"
          echo "GOOGLE_APPLICATION_CREDENTIALS: $GOOGLE_APPLICATION_CREDENTIALS"
          echo "GOOGLE_CLOUD_PROJECT: ${{ secrets.GOOGLE_CLOUD_PROJECT || 'calmi-99482' }}"
          
          echo "üì¶ Installation locale des d√©pendances manquantes..."
          npm install --no-package-lock
          
          firebase deploy --only functions:v2 \
            --project ${{ secrets.GOOGLE_CLOUD_PROJECT || 'calmi-99482' }} \
            --token "${{ secrets.FIREBASE_TOKEN }}" \
            --debug
