
name: DÃ©ploiement des Functions v2 SimplifiÃ©es
on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environnement de dÃ©ploiement"
        required: true
        default: "production"
        type: choice
        options:
          - production
          - staging

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v3
      
      - name: Configuration de Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
      
      - name: Installation directe (ultra-simplifiÃ©e)
        working-directory: functions-v2
        run: |
          echo "ðŸ“¢ DÃ©but de l'installation ultra-simplifiÃ©e"
          
          echo "ðŸ§¹ Nettoyage des dossiers..."
          rm -rf node_modules lib package-lock.json

          echo "ðŸ“ VÃ©rification de la structure de rÃ©pertoires..."
          mkdir -p functions-v2
          
          echo "ðŸ“¦ Installation des dÃ©pendances minimales (sans build)..."
          npm install --omit=dev
          
          echo "âœ… DÃ©pendances installÃ©es:"
          npm list --depth=0
          
          echo "ðŸ“„ VÃ©rification des fichiers importants:" 
          ls -la
          cat index.js
      
      - name: Configuration du compte de service Firebase
        env:
          FIREBASE_SERVICE_ACCOUNT_JSON: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        run: |
          echo "$FIREBASE_SERVICE_ACCOUNT_JSON" > /tmp/firebase-service-account.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=/tmp/firebase-service-account.json" >> $GITHUB_ENV
          
          echo "âœ… Variables d'environnement dÃ©finies:"
          env | grep GOOGLE
      
      - name: Installation de Firebase CLI
        run: npm install -g firebase-tools@13.0.2
      
      - name: DÃ©ploiement direct des Functions v2
        working-directory: functions-v2
        run: |
          echo "ðŸš€ DÃ©but du dÃ©ploiement des fonctions v2..."
          
          echo "ðŸ“„ VÃ©rification de l'index.js avant dÃ©ploiement:"
          cat index.js
          
          echo "ðŸ“„ VÃ©rification de package.json avant dÃ©ploiement:"
          cat package.json
          
          echo "ðŸ“„ VÃ©rification de functions.yaml avant dÃ©ploiement:"
          cat functions.yaml
          
          echo "ðŸ”‘ Utilisation des variables d'environnement:"
          echo "GOOGLE_APPLICATION_CREDENTIALS: $GOOGLE_APPLICATION_CREDENTIALS"
          echo "GOOGLE_CLOUD_PROJECT: ${{ secrets.GOOGLE_CLOUD_PROJECT || 'calmi-99482' }}"
          
          firebase deploy --only functions:v2 \
            --project ${{ secrets.GOOGLE_CLOUD_PROJECT || 'calmi-99482' }} \
            --token "${{ secrets.FIREBASE_TOKEN }}" \
            --debug

