
name: DÃ©ploiement des Functions v2
on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environnement de dÃ©ploiement"
        required: true
        default: "production"
        type: choice
        options:
          - production
          - staging

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v3
      
      - name: Configuration de Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
      
      - name: Installation et vÃ©rification de Firebase CLI
        run: |
          echo "ðŸ”„ Installation de Firebase CLI v13.0.2..."
          npm install -g firebase-tools@13.0.2 --force
          
          echo "ðŸ” VÃ©rification de la version installÃ©e:"
          firebase --version
          
          # VÃ©rification critique que la version 13.0.2 est bien installÃ©e
          CLI_VERSION=$(firebase --version | cut -d' ' -f1)
          if [[ "$CLI_VERSION" != "13.0.2" ]]; then
            echo "âš ï¸ ERREUR: La version installÃ©e n'est pas 13.0.2 mais $CLI_VERSION. Nouvelle tentative..."
            npm cache clean --force
            npm install -g firebase-tools@13.0.2 --force
            firebase --version
          fi
          
          echo "âœ… Firebase CLI v13.0.2 correctement installÃ©e"
      
      - name: PrÃ©paration de l'environnement de dÃ©ploiement
        uses: ./.github/workflows/actions/setup-env
        with:
          working-directory: functions-v2
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          google-cloud-project: ${{ secrets.GOOGLE_CLOUD_PROJECT || 'calmi-99482' }}
      
      - name: Installation des dÃ©pendances dans functions-v2
        working-directory: functions-v2
        run: |
          echo "ðŸ“¦ Nettoyage et installation complÃ¨te des dÃ©pendances..."
          rm -rf node_modules lib package-lock.json
          npm install --no-package-lock
          
          # VÃ©rification des dÃ©pendances Firebase
          echo "ðŸ” VÃ©rification des dÃ©pendances Firebase..."
          if [ ! -d "node_modules/firebase-admin" ]; then
            echo "âš ï¸ firebase-admin manquant, installation spÃ©cifique..."
            npm install firebase-admin@13.0.2 --save --no-package-lock
          fi
          
          if [ ! -d "node_modules/firebase-functions" ]; then
            echo "âš ï¸ firebase-functions manquant, installation spÃ©cifique..."
            npm install firebase-functions@6.3.1 --save --no-package-lock
          fi
          
          # VÃ©rification finale
          echo "ðŸ“‹ Liste des dÃ©pendances Firebase installÃ©es:"
          npm list firebase-admin firebase-functions --depth=0
      
      - name: Configuration du compte de service Firebase
        uses: ./.github/workflows/actions/setup-firebase-service
        with:
          firebase-service-account: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
      
      - name: Build et prÃ©paration du rÃ©pertoire lib
        working-directory: functions-v2
        run: |
          echo "ðŸ”¨ Compilation des fonctions..."
          npm run build
          
          echo "ðŸ“¦ PrÃ©paration du rÃ©pertoire lib pour le dÃ©ploiement..."
          cp package.json lib/
          cp functions.yaml lib/
          
          echo "ðŸ“¦ Installation des dÃ©pendances dans lib..."
          cd lib
          npm install --production --no-package-lock
          
          echo "ðŸ“‚ VÃ©rification du contenu de lib/node_modules:"
          ls -la node_modules/firebase-admin || echo "âŒ firebase-admin est manquant!"
          ls -la node_modules/firebase-functions || echo "âŒ firebase-functions est manquant!"
          
          echo "{\"projects\": {\"default\": \"${{ secrets.GOOGLE_CLOUD_PROJECT || 'calmi-99482' }}\"}}" > .firebaserc
      
      - name: DÃ©ploiement avec Firebase CLI
        working-directory: functions-v2/lib
        run: |
          echo "ðŸš€ DÃ©ploiement des fonctions v2..."
          GOOGLE_APPLICATION_CREDENTIALS=/tmp/firebase-service-account.json firebase deploy --only functions:v2 --project ${{ secrets.GOOGLE_CLOUD_PROJECT || 'calmi-99482' }} --token "${{ secrets.FIREBASE_TOKEN }}" --debug
