
name: Déploiement des Functions v2
on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environnement de déploiement"
        required: true
        default: "production"
        type: choice
        options:
          - production
          - staging

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v3
      
      - name: Configuration de Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
      
      - name: Installation et vérification de Firebase CLI
        run: |
          echo "🔄 Installation de Firebase CLI v13.0.2..."
          npm install -g firebase-tools@13.0.2 --force
          
          echo "🔍 Vérification de la version installée:"
          firebase --version
          
          # Vérification critique que la version 13.0.2 est bien installée
          CLI_VERSION=$(firebase --version | cut -d' ' -f1)
          if [[ "$CLI_VERSION" != "13.0.2" ]]; then
            echo "⚠️ ERREUR: La version installée n'est pas 13.0.2 mais $CLI_VERSION. Nouvelle tentative..."
            npm cache clean --force
            npm install -g firebase-tools@13.0.2 --force
            firebase --version
          fi
          
          echo "✅ Firebase CLI v13.0.2 correctement installée"
      
      - name: Préparation de l'environnement de déploiement
        uses: ./.github/workflows/actions/setup-env
        with:
          working-directory: functions-v2
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          google-cloud-project: ${{ secrets.GOOGLE_CLOUD_PROJECT || 'calmi-99482' }}
      
      - name: Installation des dépendances dans functions-v2
        working-directory: functions-v2
        run: |
          echo "📦 Nettoyage et installation complète des dépendances..."
          rm -rf node_modules lib package-lock.json
          npm install --no-package-lock
          
          # Vérification des dépendances Firebase
          echo "🔍 Vérification des dépendances Firebase..."
          if [ ! -d "node_modules/firebase-admin" ]; then
            echo "⚠️ firebase-admin manquant, installation spécifique..."
            npm install firebase-admin@13.0.2 --save --no-package-lock
          fi
          
          if [ ! -d "node_modules/firebase-functions" ]; then
            echo "⚠️ firebase-functions manquant, installation spécifique..."
            npm install firebase-functions@6.3.1 --save --no-package-lock
          fi
          
          # Vérification finale
          echo "📋 Liste des dépendances Firebase installées:"
          npm list firebase-admin firebase-functions --depth=0
      
      - name: Configuration du compte de service Firebase
        uses: ./.github/workflows/actions/setup-firebase-service
        with:
          firebase-service-account: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
      
      - name: Build et préparation du répertoire lib
        working-directory: functions-v2
        run: |
          echo "🔨 Compilation des fonctions..."
          npm run build
          
          echo "📦 Préparation du répertoire lib pour le déploiement..."
          cp package.json lib/
          cp functions.yaml lib/
          
          echo "📦 Installation des dépendances dans lib..."
          cd lib
          npm install --production --no-package-lock
          
          echo "📂 Vérification du contenu de lib/node_modules:"
          ls -la node_modules/firebase-admin || echo "❌ firebase-admin est manquant!"
          ls -la node_modules/firebase-functions || echo "❌ firebase-functions est manquant!"
          
          echo "{\"projects\": {\"default\": \"${{ secrets.GOOGLE_CLOUD_PROJECT || 'calmi-99482' }}\"}}" > .firebaserc
      
      - name: Déploiement avec Firebase CLI
        working-directory: functions-v2/lib
        run: |
          echo "🚀 Déploiement des fonctions v2..."
          GOOGLE_APPLICATION_CREDENTIALS=/tmp/firebase-service-account.json firebase deploy --only functions:v2 --project ${{ secrets.GOOGLE_CLOUD_PROJECT || 'calmi-99482' }} --token "${{ secrets.FIREBASE_TOKEN }}" --debug
