
name: DÃ©ploiement des Functions v2 SimplifiÃ©es
on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environnement de dÃ©ploiement"
        required: true
        default: "production"
        type: choice
        options:
          - production
          - staging

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v3
      
      - name: Configuration de Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
      
      - name: PrÃ©paration du projet Functions v2
        working-directory: functions-v2
        run: |
          echo "ðŸ” Diagnostic de l'environnement"
          node -v
          npm -v
          
          echo "ðŸ§¹ Nettoyage complet..."
          rm -rf node_modules lib package-lock.json
          
          echo "ðŸ”§ PrÃ©paration du package.json..."
          cat package.json
          
          echo "ðŸ“¦ Installation explicite des dÃ©pendances Firebase..."
          npm install firebase-admin@13.0.2 firebase-functions@6.3.1 cors@2.8.5 --no-package-lock
          
          echo "ðŸ” VÃ©rification des node_modules aprÃ¨s installation"
          find node_modules -name "firebase-admin" -type d
          find node_modules -name "firebase-functions" -type d
          
          echo "ðŸ“ Structure du dossier courant"
          ls -la
          
          echo "âœ… PrÃ©paration terminÃ©e"
      
      - name: Configuration du compte de service Firebase
        uses: ./.github/workflows/actions/setup-firebase-service
        with:
          firebase-service-account: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
      
      - name: Installation de Firebase CLI
        run: npm install -g firebase-tools@13.0.2
      
      - name: PrÃ©paration du fichier functions.yaml
        working-directory: functions-v2
        run: |
          echo "# Configuration pour Firebase Functions v2" > functions.yaml
          echo "specVersion: v1" >> functions.yaml
          echo "functions:" >> functions.yaml
          echo "  - source: ." >> functions.yaml
          echo "    codebase: v2" >> functions.yaml
          echo "    runtime: nodejs20" >> functions.yaml
          echo "    memory: 1GB" >> functions.yaml
          echo "    timeout: 540s" >> functions.yaml
          
          echo "ðŸ“„ Fichier functions.yaml crÃ©Ã©:"
          cat functions.yaml
      
      - name: DÃ©ploiement avec mÃ©thode directe
        working-directory: functions-v2
        run: |
          echo "ðŸš€ DÃ©ploiement des fonctions v2..."
          
          echo "ðŸ“„ Contenu du fichier index.js:"
          cat index.js
          
          echo "ðŸ“„ Contenu du package.json:"
          cat package.json
          
          echo "ðŸ“„ Contenu du functions.yaml:"
          cat functions.yaml
          
          echo "ðŸ”‘ Variables d'environnement:"
          echo "GOOGLE_APPLICATION_CREDENTIALS: $GOOGLE_APPLICATION_CREDENTIALS"
          echo "GOOGLE_CLOUD_PROJECT: ${{ secrets.GOOGLE_CLOUD_PROJECT || 'calmi-99482' }}"
          
          echo "ðŸ“¦ Copie des node_modules pour le dÃ©ploiement..."
          # Assurez-vous que les modules sont accessibles au moment du dÃ©ploiement
          mkdir -p lib
          cp -r node_modules lib/ || echo "Pas de node_modules Ã  copier"
          cp package.json lib/ || echo "Pas de package.json Ã  copier"
          cp functions.yaml lib/ || echo "Pas de functions.yaml Ã  copier"
          cp index.js lib/ || echo "Pas d'index.js Ã  copier"
          
          echo "ðŸš€ ExÃ©cution du dÃ©ploiement Firebase..."
          firebase deploy --only functions:v2 \
            --project ${{ secrets.GOOGLE_CLOUD_PROJECT || 'calmi-99482' }} \
            --token "${{ secrets.FIREBASE_TOKEN }}" \
            --debug
