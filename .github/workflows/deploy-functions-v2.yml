
name: DÃ©ploiement des Functions v2
on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environnement de dÃ©ploiement"
        required: true
        default: "production"
        type: choice
        options:
          - production
          - staging

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v3
      
      - name: Configuration de Node.js
        uses: ./.github/workflows/actions/setup-node
      
      - name: VÃ©rification de l'installation de Node.js
        run: |
          node -v
          npm -v
      
      - name: PrÃ©paration de l'environnement de dÃ©ploiement
        working-directory: functions-v2
        run: |
          echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" > .env
          echo "GOOGLE_CLOUD_PROJECT=${{ secrets.GOOGLE_CLOUD_PROJECT || 'calmi-99482' }}" >> .env
          echo "Variables d'environnement configurÃ©es avec succÃ¨s"
      
      - name: Installation explicite des dÃ©pendances critiques
        working-directory: functions-v2
        run: |
          rm -rf node_modules
          rm -f package-lock.json
          echo "ðŸ“¦ Installation explicite de firebase-admin et firebase-functions..."
          npm install firebase-admin@latest firebase-functions@latest --no-package-lock
          mkdir -p node_modules
          ls -la node_modules/firebase-admin || echo "firebase-admin non installÃ©"
          ls -la node_modules/firebase-functions || echo "firebase-functions non installÃ©"
          
          # Double vÃ©rification
          if [ ! -d "node_modules/firebase-admin" ] || [ ! -d "node_modules/firebase-functions" ]; then
            echo "âš ï¸ RÃ©installation des dÃ©pendances critiques..."
            npm install firebase-admin@latest firebase-functions@latest --force --no-package-lock
          fi
      
      - name: Installation des dÃ©pendances
        working-directory: functions-v2
        run: |
          npm install --no-package-lock
          
          # VÃ©rification approfondie des dÃ©pendances critiques
          echo "ðŸ“¦ VÃ©rification des dÃ©pendances critiques..."
          ls -la node_modules/firebase-admin || echo "firebase-admin manquant, installation..."
          ls -la node_modules/firebase-functions || echo "firebase-functions manquant, installation..."
          
          # Assurer que les dÃ©pendances critiques sont prÃ©sentes
          if [ ! -d "node_modules/firebase-admin" ]; then
            npm install firebase-admin@latest --force --no-package-lock
          fi
          
          if [ ! -d "node_modules/firebase-functions" ]; then
            npm install firebase-functions@latest --force --no-package-lock
          fi
          
          echo "ðŸ“¦ Liste des dÃ©pendances principales installÃ©es:"
          npm list --depth=0 firebase-admin firebase-functions
      
      - name: Configuration du compte de service Firebase
        uses: ./.github/workflows/actions/setup-firebase-service
        with:
          firebase-service-account: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
      
      - name: Installation et mise Ã  jour de Firebase CLI
        run: |
          npm uninstall -g firebase-tools
          npm install -g firebase-tools@latest
          firebase --version
          # VÃ©rification que la version CLI est compatible avec le SDK
          FIREBASE_CLI_VERSION=$(firebase --version)
          echo "Version de Firebase CLI installÃ©e: $FIREBASE_CLI_VERSION"
          # S'assurer que la version est suffisamment rÃ©cente (12.0.0+)
          if [[ "$FIREBASE_CLI_VERSION" =~ ^([0-9]+) && "${BASH_REMATCH[1]}" -lt 12 ]]; then
            echo "âš ï¸ La version de Firebase CLI est trop ancienne. Installation forcÃ©e de la derniÃ¨re version."
            npm install -g firebase-tools@latest --force
            firebase --version
          fi
      
      - name: Build et prÃ©paration pour le dÃ©ploiement
        working-directory: functions-v2
        run: |
          # Nettoyage du rÃ©pertoire lib s'il existe
          rm -rf lib
          
          # Compilation du code
          echo "ðŸ”¨ Compilation du code..."
          npm run build
          
          # VÃ©rification que le rÃ©pertoire lib existe aprÃ¨s la compilation
          if [ ! -d "lib" ]; then
            echo "âŒ Erreur: Le rÃ©pertoire lib n'a pas Ã©tÃ© crÃ©Ã© pendant la compilation"
            exit 1
          fi
          
          # CrÃ©ation du fichier functions.yaml explicite avec specVersion v1
          echo "# Configuration Firebase Functions v2" > functions.yaml
          echo "specVersion: v1" >> functions.yaml
          echo "functions:" >> functions.yaml
          echo "  - source: ." >> functions.yaml
          echo "    codebase: v2" >> functions.yaml
          echo "    runtime: nodejs20" >> functions.yaml
          echo "    memory: 1GB" >> functions.yaml
          echo "    timeout: 540s" >> functions.yaml
          
          cat functions.yaml
          
          # Copie des dÃ©pendances dans lib
          echo "ðŸ“¦ Copie des dÃ©pendances dans lib..."
          npm run copy-deps
          
          # VÃ©rification explicite de firebase-admin et firebase-functions
          if [ ! -d "lib/node_modules/firebase-admin" ]; then
            echo "âš ï¸ firebase-admin manquant dans lib/node_modules, copie d'urgence..."
            mkdir -p lib/node_modules
            cp -r node_modules/firebase-admin lib/node_modules/
          else
            echo "âœ… firebase-admin prÃ©sent dans lib/node_modules"
          fi
          
          if [ ! -d "lib/node_modules/firebase-functions" ]; then
            echo "âš ï¸ firebase-functions manquant dans lib/node_modules, copie d'urgence..."
            mkdir -p lib/node_modules
            cp -r node_modules/firebase-functions lib/node_modules/
          else
            echo "âœ… firebase-functions prÃ©sent dans lib/node_modules"
          fi
          
          # VÃ©rification finale
          echo "ðŸ“¦ Contenu de lib/node_modules:"
          ls -la lib/node_modules/
          
          # CrÃ©ation d'un package.json simplifiÃ© dans lib
          # Utiliser les versions exactes installÃ©es pour assurer la compatibilitÃ©
          FIREBASE_ADMIN_VERSION=$(npm list firebase-admin --json | jq -r '.dependencies["firebase-admin"].version')
          FIREBASE_FUNCTIONS_VERSION=$(npm list firebase-functions --json | jq -r '.dependencies["firebase-functions"].version')
          
          echo "{\"main\": \"index.js\", \"dependencies\": {\"firebase-admin\": \"^${FIREBASE_ADMIN_VERSION:-13.0.2}\", \"firebase-functions\": \"^${FIREBASE_FUNCTIONS_VERSION:-6.3.1}\"}}" > lib/package.json
          echo "âœ… package.json simplifiÃ© crÃ©Ã© dans lib avec versions: admin=${FIREBASE_ADMIN_VERSION:-13.0.2}, functions=${FIREBASE_FUNCTIONS_VERSION:-6.3.1}"
      
      - name: DÃ©ploiement des Functions v2
        working-directory: functions-v2
        run: |
          echo "ðŸš€ DÃ©ploiement des functions v2 sur ${{ secrets.GOOGLE_CLOUD_PROJECT || 'calmi-99482' }}..."
          
          # Configuration du NODE_PATH pour aider Ã  trouver les modules
          export NODE_PATH="$PWD/lib/node_modules:$NODE_PATH"
          echo "NODE_PATH=$NODE_PATH"
          
          # Configuration explicite du codebase
          echo "firebase:" > .firebaserc
          echo "  projects:" >> .firebaserc
          echo "    default: ${{ secrets.GOOGLE_CLOUD_PROJECT || 'calmi-99482' }}" >> .firebaserc
          echo "  functions:" >> .firebaserc
          echo "    - source: ." >> .firebaserc
          echo "      codebase: v2" >> .firebaserc
          
          # CrÃ©ation d'un firebase.json local pour le dÃ©ploiement avec specVersion explicite
          echo "{\"functions\": [{\"source\": \".\", \"codebase\": \"v2\", \"runtime\": \"nodejs20\", \"specVersion\": \"v1\"}]}" > firebase.json
          
          # DÃ©ploiement avec debug
          firebase deploy --only functions:v2 \
            --project ${{ secrets.GOOGLE_CLOUD_PROJECT || 'calmi-99482' }} \
            --token "${{ secrets.FIREBASE_TOKEN }}" \
            --debug
