
name: Déploiement des Functions v2 Simplifiées
on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environnement de déploiement"
        required: true
        default: "production"
        type: choice
        options:
          - production
          - staging

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v3
      
      - name: Configuration de Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
      
      - name: Installation manuelle des dépendances
        working-directory: functions-v2
        run: |
          echo "🔧 Version de Node.js:"
          node -v
          
          echo "🧹 Nettoyage complet..."
          rm -rf node_modules lib package-lock.json
          
          echo "📦 Installation DIRECTE des dépendances..."
          npm i firebase-admin@13.0.2 firebase-functions@6.3.1 cors@2.8.5 dotenv@16.5.0 --no-package-lock
          
          echo "🔍 Vérification des node_modules"
          ls -la node_modules/
          ls -la node_modules/firebase-admin/ || echo "firebase-admin non trouvé!"
          ls -la node_modules/firebase-functions/ || echo "firebase-functions non trouvé!"
          
          echo "📄 Contenu du fichier package.json:"
          cat package.json
      
      - name: Configuration du compte de service Firebase
        uses: ./.github/workflows/actions/setup-firebase-service
        with:
          firebase-service-account: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
      
      - name: Installation de Firebase CLI
        run: npm install -g firebase-tools@13.0.2
      
      - name: Préparation du déploiement
        working-directory: functions-v2
        run: |
          echo "🔧 Création du functions.yaml"
          cat > functions.yaml << 'EOF'
          specVersion: v1
          functions:
            - source: .
              codebase: v2
              runtime: nodejs20
              memory: 1GB
              timeout: 540s
          EOF
          
          echo "📄 Contenu du functions.yaml:"
          cat functions.yaml
          
          echo "📦 Vérification du fichier index.js:"
          cat index.js
          
          echo "📦 Création du dossier lib et copie des fichiers"
          mkdir -p lib
          cp index.js lib/
          cp package.json lib/
          cp functions.yaml lib/
          cp -r node_modules lib/ || echo "Pas de node_modules à copier"
          
          echo "📁 Contenu du dossier lib:"
          ls -la lib/
      
      - name: Déploiement des fonctions v2
        working-directory: functions-v2
        run: |
          echo "🚀 Exécution du déploiement Firebase..."
          
          export GOOGLE_APPLICATION_CREDENTIALS=$GOOGLE_APPLICATION_CREDENTIALS
          export GOOGLE_CLOUD_PROJECT="${{ secrets.GOOGLE_CLOUD_PROJECT || 'calmi-99482' }}"
          
          echo "🔑 Variables d'environnement:"
          echo "GOOGLE_APPLICATION_CREDENTIALS défini: ${{ env.GOOGLE_APPLICATION_CREDENTIALS != '' }}"
          echo "GOOGLE_CLOUD_PROJECT: $GOOGLE_CLOUD_PROJECT"
          
          firebase deploy --only functions:v2 \
            --project $GOOGLE_CLOUD_PROJECT \
            --token "${{ secrets.FIREBASE_TOKEN }}" \
            --debug
