
name: D√©ploiement des Functions v2
on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environnement de d√©ploiement"
        required: true
        default: "production"
        type: choice
        options:
          - production
          - staging

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v3
      
      - name: Configuration de Node.js
        uses: ./.github/workflows/actions/setup-node
      
      - name: Installation et v√©rification de Firebase CLI
        run: |
          echo "üîÑ D√©sinstallation de Firebase CLI existante..."
          npm uninstall -g firebase-tools || true
          
          echo "üîß Installation de Firebase CLI v13.0.2 sp√©cifiquement..."
          npm install -g firebase-tools@13.0.2 --force
          
          echo "üîç V√©rification de la version install√©e:"
          firebase --version
          
          # V√©rification critique que la version 13.0.2 est bien install√©e
          CLI_VERSION=$(firebase --version | cut -d' ' -f1)
          if [[ "$CLI_VERSION" != "13.0.2" ]]; then
            echo "‚ö†Ô∏è ERREUR: La version install√©e n'est pas 13.0.2 mais $CLI_VERSION. Nouvelle tentative..."
            npm cache clean --force
            npm install -g firebase-tools@13.0.2 --force
            firebase --version
            
            # Seconde v√©rification critique
            CLI_VERSION=$(firebase --version | cut -d' ' -f1)
            if [[ "$CLI_VERSION" != "13.0.2" ]]; then
              echo "‚ùå √âCHEC: Impossible d'installer Firebase CLI 13.0.2"
              exit 1
            fi
          fi
          
          echo "‚úÖ Firebase CLI v13.0.2 correctement install√©e"
      
      - name: Pr√©paration de l'environnement de d√©ploiement
        uses: ./.github/workflows/actions/setup-env
        with:
          working-directory: functions-v2
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          google-cloud-project: ${{ secrets.GOOGLE_CLOUD_PROJECT || 'calmi-99482' }}
      
      - name: Installation des d√©pendances
        run: |
          cd functions-v2
          echo "üì¶ Installation compl√®te des d√©pendances..."
          rm -rf node_modules package-lock.json
          npm install --no-package-lock
          
          # V√©rification des d√©pendances essentielles
          echo "üîç V√©rification des d√©pendances Firebase..."
          npm list firebase-admin firebase-functions --depth=0
      
      - name: Configuration du compte de service Firebase
        uses: ./.github/workflows/actions/setup-firebase-service
        with:
          firebase-service-account: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
      
      - name: V√©rification approfondie de la configuration
        working-directory: functions-v2
        run: |
          echo "üì¶ Verification des d√©pendances install√©es:"
          npm list firebase-admin firebase-functions --depth=0
          
          echo "üìÑ Contenu du functions.yaml:"
          cat functions.yaml
          
          echo "üìÑ Contenu du package.json des functions-v2:"
          cat package.json
      
      - name: Build et d√©ploiement
        uses: ./.github/workflows/actions/build-deploy
        with:
          working-directory: functions-v2
          project-id: ${{ secrets.GOOGLE_CLOUD_PROJECT || 'calmi-99482' }}
          firebase-token: ${{ secrets.FIREBASE_TOKEN }}
          deploy-target: functionsV2
