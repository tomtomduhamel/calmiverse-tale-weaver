
name: "Build et dÃ©ploiement"
description: "Compile et dÃ©ploie les functions Firebase"

inputs:
  project-id:
    description: "ID du projet Firebase"
    required: true
  firebase-token:
    description: "Token Firebase CLI"
    required: true
  working-directory:
    description: "RÃ©pertoire de travail"
    required: true
  deploy-target:
    description: "Cible de dÃ©ploiement (functions ou functionsV2)"
    required: false
    default: "functions"

runs:
  using: "composite"
  steps:
    - name: VÃ©rification de l'environnement
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "ðŸ” VÃ©rification de l'environnement de build..."
        echo "ðŸ“¦ Version de Node.js: $(node -v)"
        echo "ðŸ“¦ Version de npm: $(npm -v)"
        
        if [ ! -f "package.json" ]; then
          echo "âŒ package.json non trouvÃ© dans $(pwd)"
          exit 1
        fi
        
        # VÃ©rifier que les variables d'environnement sont dÃ©finies
        if [ -z "${{ inputs.project-id }}" ]; then
          echo "âŒ project-id manquant"
          exit 1
        fi
        
        if [ -z "${{ inputs.firebase-token }}" ]; then
          echo "âŒ firebase-token manquant"
          exit 1
        fi
        
        # Installation explicite des dÃ©pendances critiques avec rÃ©solution des conflits
        echo "ðŸ“¦ Installation explicite des dÃ©pendances critiques..."
        rm -rf node_modules/firebase-admin node_modules/firebase-functions
        npm install firebase-admin@latest firebase-functions@latest --force --no-package-lock
        
        # VÃ©rification approfondie des dÃ©pendances
        if [ ! -d "node_modules/firebase-admin" ]; then
          echo "âŒ firebase-admin n'est PAS installÃ© correctement!"
          mkdir -p node_modules
          npm install firebase-admin@latest --force --no-package-lock
        else
          echo "âœ… firebase-admin est correctement installÃ©"
          ls -la node_modules/firebase-admin
        fi
        
        if [ ! -d "node_modules/firebase-functions" ]; then
          echo "âŒ firebase-functions n'est PAS installÃ© correctement!"
          mkdir -p node_modules
          npm install firebase-functions@latest --force --no-package-lock
        else
          echo "âœ… firebase-functions est installÃ© avec succÃ¨s"
          ls -la node_modules/firebase-functions
        fi

    - name: Build Functions
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "ðŸ”¨ Compilation des fonctions..."
        # Nettoyer le dossier lib avant la compilation
        rm -rf lib
        
        # Compiler avec TypeScript
        npm run build
        
        if [ $? -ne 0 ]; then
          echo "âŒ ERREUR de compilation"
          exit 1
        fi
        
        # VÃ©rifier le contenu du dossier lib
        if [ ! -d "lib" ] || [ -z "$(ls -A lib 2>/dev/null)" ]; then
          echo "âŒ Le dossier lib est vide ou n'existe pas aprÃ¨s la compilation"
          ls -la
          exit 1
        fi
        
        echo "âœ… Build terminÃ© avec succÃ¨s"
        echo "ðŸ“ Structure du dossier lib:"
        find lib -type f | sort
        
        # ExÃ©cuter le script pour copier les dÃ©pendances dans lib
        echo "ðŸ“¦ Copie des dÃ©pendances dans lib pour le dÃ©ploiement..."
        npm run copy-deps
        
        # VÃ©rification des dÃ©pendances copiÃ©es
        echo "ðŸ“¦ VÃ©rification des dÃ©pendances copiÃ©es:"
        if [ ! -d "lib/node_modules/firebase-admin" ]; then
          echo "âš ï¸ firebase-admin manquant dans lib/node_modules, copie d'urgence..."
          mkdir -p lib/node_modules
          cp -r node_modules/firebase-admin lib/node_modules/
          
          # Double vÃ©rification aprÃ¨s copie
          if [ ! -d "lib/node_modules/firebase-admin" ]; then
            echo "âŒ ERREUR CRITIQUE: Impossible de copier firebase-admin dans lib/node_modules"
            ls -la node_modules
            exit 1
          fi
        else
          echo "âœ… firebase-admin est prÃ©sent dans lib/node_modules"
          ls -la lib/node_modules/firebase-admin
        fi
        
        if [ ! -d "lib/node_modules/firebase-functions" ]; then
          echo "âš ï¸ firebase-functions manquant dans lib/node_modules, copie d'urgence..."
          mkdir -p lib/node_modules
          cp -r node_modules/firebase-functions lib/node_modules/
          
          # Double vÃ©rification aprÃ¨s copie
          if [ ! -d "lib/node_modules/firebase-functions" ]; then
            echo "âŒ ERREUR CRITIQUE: Impossible de copier firebase-functions dans lib/node_modules"
            ls -la node_modules
            exit 1
          fi
        else
          echo "âœ… firebase-functions est prÃ©sent dans lib/node_modules"
          ls -la lib/node_modules/firebase-functions
        fi
    
    - name: Configuration de Firebase
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "ðŸ”§ Configuration de Firebase pour le projet ${{ inputs.project-id }}..."
        echo '{"projects": {"default": "${{ inputs.project-id }}"}}' > .firebaserc
    
    - name: DÃ©ploiement des Functions
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "ðŸš€ DÃ©ploiement des fonctions sur ${{ inputs.project-id }}..."
        
        # VÃ©rifier une derniÃ¨re fois que le dossier lib et ses dÃ©pendances existent
        if [ ! -d "lib" ]; then
          echo "âŒ Le dossier lib n'existe pas avant le dÃ©ploiement"
          exit 1
        fi
        
        # CrÃ©er un package.json simplifiÃ© dans lib si nÃ©cessaire
        if [ ! -f "lib/package.json" ]; then
          echo "{\"main\": \"index.js\", \"dependencies\": {\"firebase-admin\": \"^13.0.2\", \"firebase-functions\": \"^6.3.1\"}}" > lib/package.json
          echo "âœ… package.json simplifiÃ© crÃ©Ã© dans lib"
        fi
        
        # VÃ©rifier le contenu du dossier lib/node_modules
        echo "ðŸ“¦ Contenu de lib/node_modules avant dÃ©ploiement:"
        ls -la lib/node_modules || echo "lib/node_modules n'existe pas"
        
        # Copie d'urgence des dÃ©pendances critiques
        if [ ! -d "lib/node_modules/firebase-admin" ]; then
          echo "âš ï¸ Copie d'urgence de firebase-admin dans lib/node_modules..."
          mkdir -p lib/node_modules
          cp -r node_modules/firebase-admin lib/node_modules/
        fi
        
        if [ ! -d "lib/node_modules/firebase-functions" ]; then
          echo "âš ï¸ Copie d'urgence de firebase-functions dans lib/node_modules..."
          mkdir -p lib/node_modules
          cp -r node_modules/firebase-functions lib/node_modules/
        fi
        
        # Installer npm dans lib si nÃ©cessaire
        if [ ! -d "lib/node_modules/npm" ]; then
          echo "ðŸ“¦ Installation de npm dans lib/node_modules..."
          cd lib && npm install npm --no-save --no-package-lock && cd ..
        fi
        
        # Ajouter node_modules Ã  NODE_PATH pour s'assurer que les modules sont trouvÃ©s
        export NODE_PATH="$PWD/lib/node_modules:$NODE_PATH"
        echo "NODE_PATH=$NODE_PATH"
        
        # DÃ©terminer la cible de dÃ©ploiement
        if [ "${{ inputs.deploy-target }}" = "functionsV2" ]; then
          DEPLOY_TARGET="--only functions:v2"
          echo "DÃ©ploiement des functions v2"
        else
          DEPLOY_TARGET="--only functions"
          echo "DÃ©ploiement des functions standard"
        fi
        
        # CrÃ©er un functions.yml temporaire pour debug
        echo "functions:" > functions.yml
        echo "  - source: ." >> functions.yml
        echo "    runtime: nodejs20" >> functions.yml
        
        # DÃ©ployer avec le mode debug pour plus d'informations
        firebase deploy $DEPLOY_TARGET \
          --project ${{ inputs.project-id }} \
          --token "${{ inputs.firebase-token }}" \
          --non-interactive \
          --debug
