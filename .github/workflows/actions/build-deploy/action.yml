
name: 'Build et dÃ©ploiement'
description: 'Compile et dÃ©ploie les functions Firebase'

inputs:
  project-id:
    description: 'ID du projet Firebase'
    required: true
  firebase-token:
    description: 'Token Firebase CLI'
    required: true
  working-directory:
    description: 'RÃ©pertoire de travail'
    required: true

runs:
  using: 'composite'
  steps:
    - name: VÃ©rification de l'environnement
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "ğŸ” VÃ©rification de l'environnement de build..."
        echo "ğŸ“¦ Version de Node.js: $(node -v)"
        echo "ğŸ“¦ Version de npm: $(npm -v)"
        echo "ğŸ“ Contenu du rÃ©pertoire de travail:"
        ls -la
        echo "ğŸ“„ Contenu du package.json:"
        cat package.json
        
    - name: Build Functions v2
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "ğŸ”¨ Compilation des fonctions v2..."
        npm run build
        
        if [ $? -ne 0 ]; then
          echo "âŒ ERREUR de compilation"
          exit 1
        fi
        echo "âœ… Build terminÃ© avec succÃ¨s"
        
        # VÃ©rification supplÃ©mentaire du contenu du dossier lib
        if [ ! -d "lib" ] || [ -z "$(ls -A lib 2>/dev/null)" ]; then
          echo "âŒ Le dossier lib est vide ou n'existe pas aprÃ¨s la compilation"
          ls -la
          exit 1
        fi
        
        echo "ğŸ“ Contenu du dossier lib:"
        ls -la lib/
    
    - name: DÃ©ploiement des Functions v2
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "ğŸš€ DÃ©ploiement des fonctions v2 sur ${{ inputs.project-id }}"
        firebase deploy --only functions:v2 --project ${{ inputs.project-id }} --token "${{ inputs.firebase-token }}" --non-interactive --debug
