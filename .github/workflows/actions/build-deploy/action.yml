
name: "Build et d√©ploiement"
description: "Compile et d√©ploie les functions Firebase"

inputs:
  project-id:
    description: "ID du projet Firebase"
    required: true
  firebase-token:
    description: "Token Firebase CLI"
    required: true
  working-directory:
    description: "R√©pertoire de travail"
    required: true
  deploy-target:
    description: "Cible de d√©ploiement (functions ou functionsV2)"
    required: false
    default: "functions"

runs:
  using: "composite"
  steps:
    - name: Pr√©paration du d√©ploiement
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "üîß Pr√©paration du d√©ploiement dans ${{ inputs.working-directory }}..."
        
        # V√©rification de l'installation de Firebase CLI
        firebase --version
        
        # Nettoyage des r√©pertoires
        rm -rf lib/node_modules/firebase-admin/node_modules lib/node_modules/firebase-functions/node_modules 2>/dev/null || true
        
        # Si le dossier lib n'existe pas encore, le cr√©er
        if [ ! -d "lib" ]; then
          echo "üèóÔ∏è Compilation TypeScript..."
          npm run build
          
          echo "üìã Copie du package.json dans lib..."
          cp package.json lib/
          
          if [ -f "functions.yaml" ]; then
            cp functions.yaml lib/
          fi
        fi
        
        # Cr√©ation du .firebaserc
        echo "{\"projects\": {\"default\": \"${{ inputs.project-id }}\"}}" > lib/.firebaserc
        
        # V√©rification et installation des d√©pendances dans lib
        cd lib
        
        if [ ! -d "node_modules" ] || [ ! -d "node_modules/firebase-admin" ] || [ ! -d "node_modules/firebase-functions" ]; then
          echo "üì¶ Installation des d√©pendances dans lib..."
          npm install --production --omit=dev
          
          # Installation explicite des modules Firebase
          npm install firebase-admin@13.0.2 firebase-functions@6.3.1 --no-package-lock
        fi
        
        echo "‚úÖ Structure du dossier de d√©ploiement:"
        ls -la
        echo "üì¶ Modules firebase install√©s:"
        ls -la node_modules | grep firebase

    - name: D√©ploiement Firebase
      shell: bash
      working-directory: ${{ inputs.working-directory }}/lib
      run: |
        echo "üöÄ D√©ploiement des fonctions Firebase..."
        
        # D√©terminer la cible de d√©ploiement
        if [ "${{ inputs.deploy-target }}" = "functionsV2" ]; then
          DEPLOY_TARGET="functions:v2"
        else
          DEPLOY_TARGET="functions"
        fi
        
        # V√©rification critique finale
        if [ ! -d "node_modules/firebase-admin" ] || [ ! -d "node_modules/firebase-functions" ]; then
          echo "‚ö†Ô∏è ERREUR CRITIQUE: Modules Firebase manquants avant d√©ploiement!"
          echo "Installation d'urgence des modules essentiels..."
          npm install firebase-admin@13.0.2 firebase-functions@6.3.1 --no-package-lock
        fi
        
        # D√©ploiement
        echo "üîç D√©ploiement de $DEPLOY_TARGET sur ${{ inputs.project-id }}..."
        GOOGLE_APPLICATION_CREDENTIALS=/tmp/firebase-service-account.json firebase deploy --only ${DEPLOY_TARGET} \
          --project ${{ inputs.project-id }} \
          --token "${{ inputs.firebase-token }}" \
          --debug
