
name: "Build et d√©ploiement"
description: "Compile et d√©ploie les functions Firebase"

inputs:
  project-id:
    description: "ID du projet Firebase"
    required: true
  firebase-token:
    description: "Token Firebase CLI"
    required: true
  working-directory:
    description: "R√©pertoire de travail"
    required: true
  deploy-target:
    description: "Cible de d√©ploiement (functions ou functionsV2)"
    required: false
    default: "functions"

runs:
  using: "composite"
  steps:
    - name: V√©rification de l'environnement
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "üîç V√©rification de l'environnement de build..."
        echo "üì¶ Version de Node.js: $(node -v)"
        echo "üì¶ Version de npm: $(npm -v)"
        
        if [ ! -f "package.json" ]; then
          echo "‚ùå package.json non trouv√© dans $(pwd)"
          exit 1
        fi

    - name: Mise √† jour de Firebase CLI (derni√®re tentative)
      shell: bash
      run: |
        echo "üîß Mise √† jour finale de Firebase CLI avant d√©ploiement..."
        npm cache clean --force
        npm uninstall -g firebase-tools || true
        npm install -g firebase-tools@13.0.2 --force
        echo "Version Firebase CLI apr√®s mise √† jour finale:"
        firebase --version
        
        # Assurer que la version est bien 13.x
        CLI_VERSION=$(firebase --version | cut -d' ' -f1)
        if [[ "$CLI_VERSION" < "13.0.0" ]]; then
          echo "‚ö†Ô∏è La version Firebase CLI est encore trop ancienne. Nouvelle tentative..."
          npm install -g firebase-tools@13.0.2 --force
          echo "Version apr√®s nouvelle tentative:"
          firebase --version
        fi

    - name: Build Functions
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "üî® Compilation des fonctions..."
        # Nettoyer le dossier lib avant la compilation
        rm -rf lib
        
        # Compiler avec TypeScript
        npm run build
        
        if [ $? -ne 0 ]; then
          echo "‚ùå ERREUR de compilation"
          exit 1
        fi
        
        # Synchroniser les versions firebase dans lib/package.json pour √©viter les incompatibilit√©s
        echo "üì¶ Pr√©paration du package.json pour d√©ploiement dans lib..."
        FIREBASE_ADMIN_VERSION="13.0.2"
        FIREBASE_FUNCTIONS_VERSION="6.3.1"
        
        # Cr√©er/mettre √† jour package.json dans lib avec les bonnes versions
        echo "{\"main\": \"index.js\", \"dependencies\": {\"firebase-admin\": \"^${FIREBASE_ADMIN_VERSION}\", \"firebase-functions\": \"^${FIREBASE_FUNCTIONS_VERSION}\"}}" > lib/package.json
        
        echo "‚úÖ Build termin√©, lib/package.json cr√©√© avec versions:"
        cat lib/package.json

    - name: Configuration de Firebase
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "üîß Configuration de Firebase pour le projet ${{ inputs.project-id }}..."
        echo "{\"projects\": {\"default\": \"${{ inputs.project-id }}\"}}" > .firebaserc
        
        # Cr√©ation/mise √† jour du fichier functions.yaml avec configuration appropri√©e
        echo "# Configuration Firebase Functions" > functions.yaml
        echo "specVersion: v1" >> functions.yaml
        echo "functions:" >> functions.yaml
        echo "  - source: ." >> functions.yaml
        if [ "${{ inputs.deploy-target }}" = "functionsV2" ]; then
          echo "    codebase: v2" >> functions.yaml
        else
          echo "    codebase: default" >> functions.yaml
        fi
        echo "    runtime: nodejs20" >> functions.yaml
        echo "    memory: 1GB" >> functions.yaml
        echo "    timeout: 540s" >> functions.yaml
        
        echo "üìÑ Contenu du fichier functions.yaml cr√©√©:"
        cat functions.yaml
    
    - name: D√©ploiement des Functions
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "üöÄ D√©ploiement des fonctions sur ${{ inputs.project-id }} avec cible ${{ inputs.deploy-target }}..."
        
        # V√©rifier la version Firebase CLI install√©e
        FIREBASE_CLI_VERSION=$(firebase --version | cut -d' ' -f1)
        echo "Version Firebase CLI pour d√©ploiement: $FIREBASE_CLI_VERSION"
        
        # Si version trop ancienne, mettre √† jour une derni√®re fois
        if [[ "$FIREBASE_CLI_VERSION" < "13.0.0" ]]; then
          echo "‚ö†Ô∏è Version Firebase CLI trop ancienne, mise √† jour forc√©e avant d√©ploiement..."
          npm install -g firebase-tools@13.0.2 --force
          firebase --version
        fi
        
        # D√©terminer la cible de d√©ploiement
        if [ "${{ inputs.deploy-target }}" = "functionsV2" ]; then
          DEPLOY_TARGET="--only functions:v2"
          echo "D√©ploiement des functions v2"
        else
          DEPLOY_TARGET="--only functions"
          echo "D√©ploiement des functions standard"
        fi
        
        # Afficher le contenu du fichier functions.yaml
        echo "üìÑ Contenu du fichier functions.yaml avant d√©ploiement:"
        cat functions.yaml
        
        # D√©ployer avec la Firebase CLI mise √† jour
        echo "üîç D√©ploiement avec Firebase CLI $(firebase --version)"
        firebase deploy $DEPLOY_TARGET \
          --project ${{ inputs.project-id }} \
          --token "${{ inputs.firebase-token }}" \
          --non-interactive \
          --debug
