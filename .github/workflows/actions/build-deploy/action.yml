
name: "Build et dÃ©ploiement"
description: "Compile et dÃ©ploie les functions Firebase"

inputs:
  project-id:
    description: "ID du projet Firebase"
    required: true
  firebase-token:
    description: "Token Firebase CLI"
    required: true
  working-directory:
    description: "RÃ©pertoire de travail"
    required: true
  deploy-target:
    description: "Cible de dÃ©ploiement (functions ou functionsV2)"
    required: false
    default: "functions"

runs:
  using: "composite"
  steps:
    - name: VÃ©rification de l'environnement
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "ðŸ” VÃ©rification de l'environnement de build..."
        echo "ðŸ“¦ Version de Node.js: $(node -v)"
        echo "ðŸ“¦ Version de npm: $(npm -v)"
        
        if [ ! -f "package.json" ]; then
          echo "âŒ package.json non trouvÃ© dans $(pwd)"
          exit 1
        fi

    - name: Installation et mise Ã  jour de Firebase CLI
      shell: bash
      run: |
        npm uninstall -g firebase-tools
        npm install -g firebase-tools@latest
        firebase --version
        # VÃ©rification que la version CLI est compatible
        FIREBASE_CLI_VERSION=$(firebase --version)
        echo "Version de Firebase CLI installÃ©e: $FIREBASE_CLI_VERSION"
        # S'assurer que la version est suffisamment rÃ©cente (12.0.0+)
        if [[ "$FIREBASE_CLI_VERSION" =~ ^([0-9]+) && "${BASH_REMATCH[1]}" -lt 12 ]]; then
          echo "âš ï¸ La version de Firebase CLI est trop ancienne. Installation forcÃ©e de la derniÃ¨re version."
          npm install -g firebase-tools@latest --force
          firebase --version
        fi

    - name: Build Functions
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "ðŸ”¨ Compilation des fonctions..."
        # Nettoyer le dossier lib avant la compilation
        rm -rf lib
        
        # Compiler avec TypeScript
        npm run build
        
        if [ $? -ne 0 ]; then
          echo "âŒ ERREUR de compilation"
          exit 1
        fi
        
        # Copier les dÃ©pendances et crÃ©er package.json simplifiÃ©
        echo "ðŸ“¦ Copie des dÃ©pendances dans lib..."
        npm run copy-deps
        
        # VÃ©rification des dÃ©pendances copiÃ©es
        if [ ! -d "lib/node_modules/firebase-admin" ]; then
          echo "âš ï¸ Copie manuelle de firebase-admin..."
          mkdir -p lib/node_modules
          cp -r node_modules/firebase-admin lib/node_modules/
        fi
        
        if [ ! -d "lib/node_modules/firebase-functions" ]; then
          echo "âš ï¸ Copie manuelle de firebase-functions..."
          mkdir -p lib/node_modules
          cp -r node_modules/firebase-functions lib/node_modules/
        fi
        
        # CrÃ©ation du package.json simplifiÃ© dans lib
        FIREBASE_ADMIN_VERSION=$(npm list firebase-admin --json | grep -o '"version":"[^"]*"' | cut -d'"' -f4 || echo "13.0.2")
        FIREBASE_FUNCTIONS_VERSION=$(npm list firebase-functions --json | grep -o '"version":"[^"]*"' | cut -d'"' -f4 || echo "6.3.1")
        
        echo "{\"main\": \"index.js\", \"dependencies\": {\"firebase-admin\": \"^${FIREBASE_ADMIN_VERSION}\", \"firebase-functions\": \"^${FIREBASE_FUNCTIONS_VERSION}\"}}" > lib/package.json

    - name: Configuration de Firebase
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "ðŸ”§ Configuration de Firebase pour le projet ${{ inputs.project-id }}..."
        echo "{\"projects\": {\"default\": \"${{ inputs.project-id }}\"}}" > .firebaserc
    
    - name: DÃ©ploiement des Functions
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "ðŸš€ DÃ©ploiement des fonctions sur ${{ inputs.project-id }}..."
        
        # Ajouter node_modules Ã  NODE_PATH pour s'assurer que les modules sont trouvÃ©s
        export NODE_PATH="$PWD/lib/node_modules:$NODE_PATH"
        echo "NODE_PATH=$NODE_PATH"
        
        # DÃ©terminer la cible de dÃ©ploiement
        if [ "${{ inputs.deploy-target }}" = "functionsV2" ]; then
          DEPLOY_TARGET="--only functions:v2"
          echo "DÃ©ploiement des functions v2"
        else
          DEPLOY_TARGET="--only functions"
          echo "DÃ©ploiement des functions standard"
        fi
        
        # CrÃ©er un firebase.json temporaire avec specVersion explicite
        echo "{\"functions\": [{\"source\": \".\", \"runtime\": \"nodejs20\", \"specVersion\": \"v1\"}]}" > firebase.json
        
        # DÃ©ployer avec le mode debug pour plus d'informations
        firebase deploy $DEPLOY_TARGET \
          --project ${{ inputs.project-id }} \
          --token "${{ inputs.firebase-token }}" \
          --non-interactive \
          --debug
