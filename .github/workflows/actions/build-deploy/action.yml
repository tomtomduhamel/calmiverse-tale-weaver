
name: 'Build et déploiement'
description: 'Compile et déploie les functions Firebase'

inputs:
  project-id:
    description: 'ID du projet Firebase'
    required: true
  firebase-token:
    description: 'Token Firebase CLI'
    required: true
  working-directory:
    description: 'Répertoire de travail'
    required: true

runs:
  using: 'composite'
  steps:
    - name: Vérification de l'environnement
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "🔍 Vérification de l'environnement de build..."
        echo "📦 Version de Node.js: $(node -v)"
        echo "📦 Version de npm: $(npm -v)"
        echo "📁 Contenu du répertoire de travail:"
        ls -la
        echo "📄 Contenu du package.json:"
        cat package.json
        
    - name: Build Functions v2
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "🔨 Compilation des fonctions v2..."
        npm run build
        
        if [ $? -ne 0 ]; then
          echo "❌ ERREUR de compilation"
          exit 1
        fi
        echo "✅ Build terminé avec succès"
        
        # Vérification supplémentaire du contenu du dossier lib
        if [ ! -d "lib" ] || [ -z "$(ls -A lib 2>/dev/null)" ]; then
          echo "❌ Le dossier lib est vide ou n'existe pas après la compilation"
          ls -la
          exit 1
        fi
        
        echo "📁 Contenu du dossier lib:"
        ls -la lib/
    
    - name: Déploiement des Functions v2
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "🚀 Déploiement des fonctions v2 sur ${{ inputs.project-id }}"
        firebase deploy --only functions:v2 --project ${{ inputs.project-id }} --token "${{ inputs.firebase-token }}" --non-interactive --debug
