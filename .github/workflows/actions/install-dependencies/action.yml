
name: "Installation des d√©pendances"
description: "Installe les d√©pendances npm"

inputs:
  working-directory:
    description: "R√©pertoire de travail"
    required: true
  codebase:
    description: "Type de codebase (functions ou functions-v2)"
    required: false
    default: "functions"

runs:
  using: "composite"
  steps:
    - name: Installation des d√©pendances critiques
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "üîß Pr√©paration de l'installation..."
        
        # V√©rifier la pr√©sence de package.json
        if [ ! -f "package.json" ]; then
          echo "‚ùå package.json non trouv√© dans $(pwd)"
          exit 1
        fi
        
        # Nettoyage complet pour √©viter tout conflit
        echo "üßπ Nettoyage radical des d√©pendances existantes..."
        rm -rf node_modules
        rm -f package-lock.json
        rm -rf lib/node_modules
        
        # Versions fixes absolues pour les paquets Firebase
        FIREBASE_ADMIN_VERSION="13.0.2"
        FIREBASE_FUNCTIONS_VERSION="6.3.1"
        
        echo "üì¶ Installation compl√®te des d√©pendances..."
        npm install --no-package-lock
        
        echo "üì¶ Installation explicite des d√©pendances Firebase avec versions fixes..."
        npm install firebase-admin@${FIREBASE_ADMIN_VERSION} firebase-functions@${FIREBASE_FUNCTIONS_VERSION} --save --force
        
        # V√©rification exhaustive des installations
        if [ ! -d "node_modules/firebase-admin" ]; then
          echo "‚ùå ERREUR CRITIQUE: firebase-admin n'est PAS install√© correctement!"
          npm install firebase-admin@${FIREBASE_ADMIN_VERSION} --save --force
          
          if [ ! -d "node_modules/firebase-admin" ]; then
            echo "‚ùå Installation √©chou√©e m√™me apr√®s nouvelle tentative. Abandon."
            exit 1
          fi
        else
          INSTALLED_VERSION=$(node -e "console.log(require('./node_modules/firebase-admin/package.json').version)")
          echo "‚úÖ firebase-admin est install√©: version ${INSTALLED_VERSION}"
          
          if [ "$INSTALLED_VERSION" != "$FIREBASE_ADMIN_VERSION" ]; then
            echo "‚ö†Ô∏è Version incorrecte! R√©installation forc√©e..."
            rm -rf node_modules/firebase-admin
            npm install firebase-admin@${FIREBASE_ADMIN_VERSION} --save --force
          fi
        fi
        
        if [ ! -d "node_modules/firebase-functions" ]; then
          echo "‚ùå ERREUR CRITIQUE: firebase-functions n'est PAS install√© correctement!"
          npm install firebase-functions@${FIREBASE_FUNCTIONS_VERSION} --save --force
          
          if [ ! -d "node_modules/firebase-functions" ]; then
            echo "‚ùå Installation √©chou√©e m√™me apr√®s nouvelle tentative. Abandon."
            exit 1
          fi
        else
          INSTALLED_VERSION=$(node -e "console.log(require('./node_modules/firebase-functions/package.json').version)")
          echo "‚úÖ firebase-functions est install√©: version ${INSTALLED_VERSION}"
          
          if [ "$INSTALLED_VERSION" != "$FIREBASE_FUNCTIONS_VERSION" ]; then
            echo "‚ö†Ô∏è Version incorrecte! R√©installation forc√©e..."
            rm -rf node_modules/firebase-functions
            npm install firebase-functions@${FIREBASE_FUNCTIONS_VERSION} --save --force
          fi
        fi
        
        # Mise √† jour forc√©e du package.json avec les versions exactes
        echo "üìù Mise √† jour du package.json avec les versions fixes..."
        node -e "const fs=require('fs');const pkg=require('./package.json');pkg.dependencies['firebase-admin']='13.0.2';pkg.dependencies['firebase-functions']='6.3.1';fs.writeFileSync('package.json',JSON.stringify(pkg,null,2));"
        
        # Cr√©ation du fichier functions.yaml 100% compatible
        echo "üìÑ Cr√©ation du fichier functions.yaml compatible..."
        echo "# Configuration Firebase Functions" > functions.yaml
        echo "specVersion: v1" >> functions.yaml
        echo "functions:" >> functions.yaml
        echo "  - source: ." >> functions.yaml
        if [ "${{ inputs.codebase }}" = "functions-v2" ]; then
          echo "    codebase: v2" >> functions.yaml
        else
          echo "    codebase: default" >> functions.yaml
        fi
        echo "    runtime: nodejs20" >> functions.yaml
        echo "    memory: 1GB" >> functions.yaml
        echo "    timeout: 540s" >> functions.yaml
        
        echo "‚úÖ Installation compl√®te et v√©rifi√©e des d√©pendances"
