
name: "Installation des dépendances"
description: "Installe les dépendances npm"

inputs:
  working-directory:
    description: "Répertoire de travail"
    required: true

runs:
  using: "composite"
  steps:
    - name: Installation des dépendances
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "🔧 Préparation de l'installation..."
        
        # Vérifier la présence de package.json
        if [ ! -f "package.json" ]; then
          echo "❌ package.json non trouvé dans $(pwd)"
          exit 1
        fi
        
        # Nettoyer le cache npm et node_modules
        echo "🧹 Nettoyage des dépendances existantes..."
        rm -rf node_modules
        rm -f package-lock.json
        
        # Installation explicite des dépendances critiques en premier
        echo "📦 Installation explicite de firebase-admin et firebase-functions..."
        npm install firebase-admin firebase-functions --no-package-lock --save
        
        # Vérifier que les dépendances critiques sont installées
        if [ ! -d "node_modules/firebase-admin" ]; then
          echo "❌ firebase-admin n'est PAS installé correctement!"
          npm install firebase-admin@latest --force --no-package-lock --save
        else
          echo "✅ firebase-admin est installé avec succès"
          ls -la node_modules/firebase-admin
        fi
        
        if [ ! -d "node_modules/firebase-functions" ]; then
          echo "❌ firebase-functions n'est PAS installé correctement!"
          npm install firebase-functions@latest --force --no-package-lock --save
        else
          echo "✅ firebase-functions est installé avec succès"
          ls -la node_modules/firebase-functions
        fi
        
        # Installation des dépendances avec plus de détails
        echo "📦 Installation complète des dépendances..."
        npm install --no-package-lock
        
        # Vérification finale
        if [ ! -d "node_modules/firebase-admin" ] || [ ! -d "node_modules/firebase-functions" ]; then
          echo "❌ Dépendances critiques manquantes après installation complète!"
          echo "Installation de secours des dépendances critiques..."
          npm install firebase-admin@latest firebase-functions@latest --force --no-package-lock --save
        fi
        
        # Création du fichier functions.yaml
        echo "functions:" > functions.yaml
        echo "  - source: ." >> functions.yaml
        echo "    runtime: nodejs20" >> functions.yaml
        
        echo "✅ Dépendances installées avec succès"
        echo "📋 Liste des dépendances principales installées:"
        npm list --depth=0 firebase-admin firebase-functions
