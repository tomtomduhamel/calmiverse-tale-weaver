
name: "Installation des dÃ©pendances"
description: "Installe les dÃ©pendances npm"

inputs:
  working-directory:
    description: "RÃ©pertoire de travail"
    required: true
  codebase:
    description: "Type de codebase (functions ou functions-v2)"
    required: false
    default: "functions"

runs:
  using: "composite"
  steps:
    - name: Installation des dÃ©pendances critiques
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "ğŸ”§ PrÃ©paration de l'installation..."
        
        # VÃ©rifier la prÃ©sence de package.json
        if [ ! -f "package.json" ]; then
          echo "âŒ package.json non trouvÃ© dans $(pwd)"
          exit 1
        fi
        
        # Nettoyage complet pour Ã©viter tout conflit
        echo "ğŸ§¹ Nettoyage radical des dÃ©pendances existantes..."
        rm -rf node_modules
        rm -f package-lock.json
        
        # Versions fixes absolues pour les paquets Firebase
        FIREBASE_ADMIN_VERSION="13.0.2"
        FIREBASE_FUNCTIONS_VERSION="6.3.1"
        
        echo "ğŸ“¦ Installation explicite des dÃ©pendances Firebase avec versions fixes..."
        npm install firebase-admin@${FIREBASE_ADMIN_VERSION} firebase-functions@${FIREBASE_FUNCTIONS_VERSION} --save --force
        
        # VÃ©rification exhaustive des installations
        if [ ! -d "node_modules/firebase-admin" ]; then
          echo "âŒ ERREUR CRITIQUE: firebase-admin n'est PAS installÃ© correctement!"
          npm install firebase-admin@${FIREBASE_ADMIN_VERSION} --save --force
          
          if [ ! -d "node_modules/firebase-admin" ]; then
            echo "âŒ Installation Ã©chouÃ©e mÃªme aprÃ¨s nouvelle tentative. Abandon."
            exit 1
          fi
        else
          INSTALLED_VERSION=$(node -e "console.log(require('./node_modules/firebase-admin/package.json').version)")
          echo "âœ… firebase-admin est installÃ©: version ${INSTALLED_VERSION}"
          
          if [ "$INSTALLED_VERSION" != "$FIREBASE_ADMIN_VERSION" ]; then
            echo "âš ï¸ Version incorrecte! RÃ©installation forcÃ©e..."
            rm -rf node_modules/firebase-admin
            npm install firebase-admin@${FIREBASE_ADMIN_VERSION} --save --force
          fi
        fi
        
        if [ ! -d "node_modules/firebase-functions" ]; then
          echo "âŒ ERREUR CRITIQUE: firebase-functions n'est PAS installÃ© correctement!"
          npm install firebase-functions@${FIREBASE_FUNCTIONS_VERSION} --save --force
          
          if [ ! -d "node_modules/firebase-functions" ]; then
            echo "âŒ Installation Ã©chouÃ©e mÃªme aprÃ¨s nouvelle tentative. Abandon."
            exit 1
          fi
        else
          INSTALLED_VERSION=$(node -e "console.log(require('./node_modules/firebase-functions/package.json').version)")
          echo "âœ… firebase-functions est installÃ©: version ${INSTALLED_VERSION}"
          
          if [ "$INSTALLED_VERSION" != "$FIREBASE_FUNCTIONS_VERSION" ]; then
            echo "âš ï¸ Version incorrecte! RÃ©installation forcÃ©e..."
            rm -rf node_modules/firebase-functions
            npm install firebase-functions@${FIREBASE_FUNCTIONS_VERSION} --save --force
          fi
        fi
        
        # Installation des dÃ©pendances restantes
        echo "ğŸ“¦ Installation complÃ¨te des dÃ©pendances restantes..."
        npm install --no-package-lock
        
        # Mise Ã  jour forcÃ©e du package.json avec les versions exactes
        echo "ğŸ“ Mise Ã  jour du package.json avec les versions fixes..."
        node -e "const fs=require('fs');const pkg=require('./package.json');pkg.dependencies['firebase-admin']='13.0.2';pkg.dependencies['firebase-functions']='6.3.1';fs.writeFileSync('package.json',JSON.stringify(pkg,null,2));"
        
        # CrÃ©ation du fichier functions.yaml 100% compatible
        echo "ğŸ“„ CrÃ©ation du fichier functions.yaml compatible..."
        echo "# Configuration Firebase Functions" > functions.yaml
        echo "specVersion: v1" >> functions.yaml
        echo "functions:" >> functions.yaml
        echo "  - source: ." >> functions.yaml
        if [ "${{ inputs.codebase }}" = "functions-v2" ]; then
          echo "    codebase: v2" >> functions.yaml
        else
          echo "    codebase: default" >> functions.yaml
        fi
        echo "    runtime: nodejs20" >> functions.yaml
        echo "    memory: 1GB" >> functions.yaml
        echo "    timeout: 540s" >> functions.yaml
        
        echo "ğŸ“„ Contenu du fichier functions.yaml crÃ©Ã©:"
        cat functions.yaml
        
        echo "âœ… Installation complÃ¨te et vÃ©rifiÃ©e des dÃ©pendances"
