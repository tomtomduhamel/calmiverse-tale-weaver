
name: "Installation des dÃ©pendances"
description: "Installe les dÃ©pendances npm"

inputs:
  working-directory:
    description: "RÃ©pertoire de travail"
    required: true
  codebase:
    description: "Type de codebase (functions ou functions-v2)"
    required: false
    default: "functions"

runs:
  using: "composite"
  steps:
    - name: Installation des dÃ©pendances
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "ğŸ”§ PrÃ©paration de l'installation..."
        
        # VÃ©rifier la prÃ©sence de package.json
        if [ ! -f "package.json" ]; then
          echo "âŒ package.json non trouvÃ© dans $(pwd)"
          exit 1
        fi
        
        # Nettoyer le cache npm et node_modules
        echo "ğŸ§¹ Nettoyage des dÃ©pendances existantes..."
        rm -rf node_modules
        rm -f package-lock.json
        
        # DÃ©termination de la version fixe sÃ»re pour firebase packages
        FIREBASE_ADMIN_VERSION="13.0.2"
        FIREBASE_FUNCTIONS_VERSION="6.3.1"
        
        # Installation explicite des dÃ©pendances critiques avec versions fixes
        echo "ğŸ“¦ Installation explicite de firebase-admin et firebase-functions avec versions fixes..."
        npm install firebase-admin@${FIREBASE_ADMIN_VERSION} firebase-functions@${FIREBASE_FUNCTIONS_VERSION} --no-package-lock --save --force
        
        # VÃ©rifier que les dÃ©pendances critiques sont installÃ©es
        if [ ! -d "node_modules/firebase-admin" ]; then
          echo "âŒ firebase-admin n'est PAS installÃ© correctement!"
          npm install firebase-admin@${FIREBASE_ADMIN_VERSION} --force --no-package-lock --save
        else
          echo "âœ… firebase-admin est installÃ© avec succÃ¨s"
          ls -la node_modules/firebase-admin
        fi
        
        if [ ! -d "node_modules/firebase-functions" ]; then
          echo "âŒ firebase-functions n'est PAS installÃ© correctement!"
          npm install firebase-functions@${FIREBASE_FUNCTIONS_VERSION} --force --no-package-lock --save
        else
          echo "âœ… firebase-functions est installÃ© avec succÃ¨s"
          ls -la node_modules/firebase-functions
        fi
        
        # Installation des dÃ©pendances restantes avec dÃ©tails
        echo "ğŸ“¦ Installation complÃ¨te des dÃ©pendances..."
        npm install --no-package-lock
        
        # VÃ©rification finale des dÃ©pendances critiques
        if [ ! -d "node_modules/firebase-admin" ] || [ ! -d "node_modules/firebase-functions" ]; then
          echo "âŒ DÃ©pendances critiques manquantes aprÃ¨s installation complÃ¨te!"
          npm install firebase-admin@${FIREBASE_ADMIN_VERSION} firebase-functions@${FIREBASE_FUNCTIONS_VERSION} --force --no-package-lock --save
        fi
        
        # Mise Ã  jour du package.json avec les versions spÃ©cifiques pour Ã©viter les updates automatiques
        echo "ğŸ“ Mise Ã  jour de package.json avec les versions fixÃ©es..."
        sed -i 's/"firebase-admin": "\^[0-9.]*"/"firebase-admin": "^'${FIREBASE_ADMIN_VERSION}'"/g' package.json
        sed -i 's/"firebase-functions": "\^[0-9.]*"/"firebase-functions": "^'${FIREBASE_FUNCTIONS_VERSION}'"/g' package.json
        
        # CrÃ©ation du fichier functions.yaml avec configuration correcte
        echo "# Configuration Firebase Functions" > functions.yaml
        echo "specVersion: v1" >> functions.yaml
        echo "functions:" >> functions.yaml
        echo "  - source: ." >> functions.yaml
        if [ "${{ inputs.codebase }}" = "functions-v2" ]; then
          echo "    codebase: v2" >> functions.yaml
        else
          echo "    codebase: default" >> functions.yaml
        fi
        echo "    runtime: nodejs20" >> functions.yaml
        echo "    memory: 1GB" >> functions.yaml
        echo "    timeout: 540s" >> functions.yaml
        
        # Afficher les versions installÃ©es pour vÃ©rification
        echo "âœ… DÃ©pendances installÃ©es avec succÃ¨s"
        echo "ğŸ“‹ Versions de firebase installÃ©es:"
        npm list firebase-admin firebase-functions --depth=0
