
name: "Installation des dÃ©pendances"
description: "Installe les dÃ©pendances npm"

inputs:
  working-directory:
    description: "RÃ©pertoire de travail"
    required: true
  codebase:
    description: "Type de codebase (functions ou functions-v2)"
    required: false
    default: "functions"

runs:
  using: "composite"
  steps:
    - name: Installation des dÃ©pendances
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "ğŸ”§ Installation des dÃ©pendances dans ${{ inputs.working-directory }}..."
        
        # VÃ©rifier la prÃ©sence de package.json
        if [ ! -f "package.json" ]; then
          echo "âŒ package.json non trouvÃ© dans $(pwd)"
          exit 1
        fi
        
        # Nettoyage complet
        echo "ğŸ§¹ Nettoyage des installations prÃ©cÃ©dentes..."
        rm -rf node_modules lib/node_modules package-lock.json
        
        # Installation complÃ¨te
        echo "ğŸ“¦ Installation des dÃ©pendances..."
        npm install --no-package-lock
        
        # CrÃ©ation du fichier functions.yaml
        echo "ğŸ“„ CrÃ©ation du fichier functions.yaml..."
        echo "# Configuration Firebase Functions" > functions.yaml
        echo "specVersion: v1" >> functions.yaml
        echo "functions:" >> functions.yaml
        echo "  - source: ." >> functions.yaml
        
        if [ "${{ inputs.codebase }}" = "functions-v2" ]; then
          echo "    codebase: v2" >> functions.yaml
        else
          echo "    codebase: default" >> functions.yaml
        fi
        
        echo "    runtime: nodejs20" >> functions.yaml
        echo "    memory: 1GB" >> functions.yaml
        echo "    timeout: 540s" >> functions.yaml
        
        # Build si nÃ©cessaire
        if [ ! -d "lib" ]; then
          echo "ğŸ—ï¸ Compilation du code..."
          npm run build
        fi
        
        # PrÃ©paration du dossier lib
        if [ -d "lib" ]; then
          echo "ğŸ“‹ Copie de package.json dans lib..."
          cp package.json lib/
          cp functions.yaml lib/
          
          echo "ğŸ“¦ Installation des dÃ©pendances dans lib..."
          cd lib
          npm install --production --omit=dev
          
          # Installation explicite des modules Firebase
          npm install firebase-admin@13.0.2 firebase-functions@6.3.1 --no-package-lock
          
          echo "âœ… Modules installÃ©s dans lib/node_modules:"
          ls -la node_modules | grep firebase
        fi
