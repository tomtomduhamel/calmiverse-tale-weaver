<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>calmiverse-tale-weaver</title>
    <meta name="description" content="Lovable Generated Project" />
    <meta name="author" content="Lovable" />
    <meta property="og:image" content="/og-image.png" />
  </head>

  <body>
    <div id="root"></div>
    <script>
      // Configuration pour GPT Engineer avec gestion des erreurs améliorée
      window.gptengineer = {
        config: {
          cloneableObjects: true,
          debug: true,
          postMessageOptions: {
            transfer: [],
            structuredClone: true,
            fallbackToJSON: true,
            timeout: 10000 // Augmentation du timeout pour donner plus de temps aux opérations
          }
        }
      };

      // Fonction utilitaire pour le logging avec niveaux
      const logError = (source, error, level = 'warn') => {
        const logFn = console[level] || console.log;
        logFn(`[${source}] Error:`, error);
        
        // Log supplémentaire pour les erreurs critiques
        if (level === 'error') {
          console.error('Stack trace:', error?.stack);
        }
      };

      // Liste des erreurs à ignorer
      const ignoredErrors = [
        'Receiving end does not exist',
        'CORS',
        'feature',
        'vr',
        'ambient-light-sensor',
        'battery',
        'connection',
        'preload',
        'as',
        'link preloaded'
      ];

      // Fonction pour vérifier si une erreur doit être ignorée
      const shouldIgnoreError = (error) => {
        if (!error?.message) return false;
        return ignoredErrors.some(err => error.message.toLowerCase().includes(err.toLowerCase()));
      };

      // Gestion globale des erreurs
      window.addEventListener('error', function(event) {
        // Ignorer les erreurs de ressources - elles seront gérées séparément
        if (event.target && (event.target.tagName === 'LINK' || event.target.tagName === 'SCRIPT')) {
          return false;
        }

        if (event.error && shouldIgnoreError(event.error)) {
          event.preventDefault();
          logError('Global Error', event.error, 'info');
          return false;
        }

        logError('Global Error', event.error, 'error');
      }, true);

      // Gestion des promesses rejetées
      window.addEventListener('unhandledrejection', function(event) {
        if (event.reason && shouldIgnoreError(event.reason)) {
          event.preventDefault();
          logError('Unhandled Promise', event.reason, 'info');
          return false;
        }

        logError('Unhandled Promise', event.reason, 'error');
      }, true);

      // Gestion des erreurs de chargement de ressources
      window.addEventListener('error', function(event) {
        if (event.target && (event.target.tagName === 'LINK' || event.target.tagName === 'SCRIPT')) {
          const resource = event.target.src || event.target.href;
          
          // Ignorer certaines ressources non critiques
          if (resource && resource.includes('lovable.dev')) {
            logError('Resource Load', `Non-critical resource load failed: ${resource}`, 'info');
            event.preventDefault();
            return false;
          }

          logError('Resource Load', `Failed to load: ${resource}`, 'warn');
          event.preventDefault();
          return false;
        }
      }, true);

      // Initialisation différée pour laisser le temps aux ressources de charger
      window.addEventListener('load', function() {
        setTimeout(() => {
          console.log('Application fully loaded and initialized');
        }, 1000);
      });
    </script>
    <script src="https://cdn.gpteng.co/gptengineer.js" type="module"></script>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>