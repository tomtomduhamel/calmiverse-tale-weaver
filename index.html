
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    
    <!-- Preconnect pour Supabase (optimisation mobile) -->
    <link rel="preconnect" href="https://ioeihnoxvtpxtqhxklpw.supabase.co" crossorigin />
    
    <title>Calmi</title>
    <meta name="description" content="Calmi - Histoires personnalis√©es pour enfants">
    <meta name="author" content="Calmi" />
    <meta property="og:image" content="/og-image.png" />
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#A8DADC" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="Calmi" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
    
    <!-- Icons -->
    <link rel="icon" type="image/x-icon" href="https://storage.googleapis.com/gpt-engineer-file-uploads/oO9nJKjIJSU7WIUZGVB6QzqDmdj2/uploads/1769050780083-Gemini_Generated_Image_msfxepmsfxepmsfx (1).jpg">
    <link rel="icon" type="image/png" sizes="512x512" href="/icon-512.png" />
    
    <link href="./src/index.css" rel="stylesheet">
    
    <style>
      /* Emergency Loader - Visible par d√©faut, supprim√© par React */
      #emergency-loader {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(180deg, #D6EAF8 0%, #C9E4DE 50%, #F1FAEE 100%);
        z-index: 9999;
        font-family: system-ui, -apple-system, sans-serif;
      }
      
      #emergency-content {
        text-align: center;
        color: #457B9D;
      }
      
      .emergency-spinner {
        width: 48px;
        height: 48px;
        border: 4px solid #A8DADC;
        border-top-color: #457B9D;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
      }
      
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      
      .emergency-error {
        display: none;
        color: #FF6B6B;
        margin-top: 1rem;
      }
      
      .emergency-btn {
        margin-top: 1rem;
        padding: 0.75rem 1.5rem;
        background: #457B9D;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        cursor: pointer;
        font-family: inherit;
      }
      
      .emergency-btn:hover {
        background: #3a6a8a;
      }
      
      .emergency-btn-secondary {
        margin-top: 0.5rem;
        padding: 0.75rem 1.5rem;
        background: #B7E4C7;
        color: #2d3748;
        border: none;
        border-radius: 8px;
        font-size: 0.9rem;
        cursor: pointer;
        font-family: inherit;
      }
      
      .emergency-btn-secondary:hover {
        background: #95d5b2;
      }
      
      .emergency-info {
        font-size: 0.8rem;
        margin-top: 1rem;
        opacity: 0.7;
        padding: 0.5rem;
        background: rgba(255,255,255,0.3);
        border-radius: 4px;
      }
    </style>
    
    <script>
      (function(){
        // üöÄ PHASE 3: DETECTION PREVIEW MODE ULTRA-PRECOCE
        var isMobile = /Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent);
        var inIframe = false;
        try { 
          inIframe = window.self !== window.top; 
        } catch(e) { 
          inIframe = true; 
        }
        
        var isPreviewMode = isMobile && inIframe;
        window.__CALMI_PREVIEW_MODE = isPreviewMode;
        window.__CALMI_FAST_BOOT = isPreviewMode;
        
        if (isPreviewMode) {
          console.log('üöÄ [Boot] PREVIEW MODE - Ultra-tol√©rant activ√©');
        } else {
          console.log('üñ•Ô∏è [Boot] STANDARD MODE');
        }
        
        // SAFE STORAGE WRAPPER - Phase 1
        function safeLocalStorageGet(key) {
          if (isPreviewMode) return null; // Pas de localStorage en preview
          try {
            return localStorage.getItem(key);
          } catch(e) {
            return null;
          }
        }
        
        function safeLocalStorageSet(key, value) {
          if (isPreviewMode) return false; // Pas de localStorage en preview
          try {
            localStorage.setItem(key, value);
            return true;
          } catch(e) {
            return false;
          }
        }
        
        // BUILD ID pour tracking de version
        var bootLogs = []; // PHASE 6: Capturer tous les logs de boot
        
        function logBoot(msg) {
          var now = Date.now();
          var entry = { t: now, msg: msg };
          bootLogs.push(entry);
          console.log('[Boot] ' + msg);
        }
        
        logBoot('D√©but initialisation HTML');
        
        // üîç PHASE 1: DIAGNOSTIC MASSIF - User Agent complet
        logBoot('User Agent: ' + navigator.userAgent);
        logBoot('Screen: ' + window.innerWidth + 'x' + window.innerHeight);
        logBoot('Touch: ' + ('ontouchstart' in window));
        logBoot('MaxTouchPoints: ' + (navigator.maxTouchPoints || 0));
        logBoot('isMobile d√©tect√©: ' + isMobile);
        logBoot('inIframe d√©tect√©: ' + inIframe);
        logBoot('isPreviewMode: ' + isPreviewMode);
        
        try {
          var BUILD_ID = 'BUILD_' + Date.now();
          if (!isPreviewMode) {
            safeLocalStorageSet('calmi_build_id', BUILD_ID);
          }
          logBoot('BUILD_ID: ' + BUILD_ID);
        } catch(e) {
          logBoot('BUILD_ID failed: ' + e.message);
        }
        
        // Exposer les logs globalement pour l'UI d'urgence
        window.__CALMI_BOOT_LOGS = bootLogs;
        
        logBoot('Configuration storage termin√©e');
        
        // PHASE 3: Tracker les scripts qui se chargent
        var scriptsLoading = [];
        try {
          var observer = new PerformanceObserver(function(list) {
            list.getEntries().forEach(function(entry) {
              if (entry.initiatorType === 'script') {
                scriptsLoading.push({
                  name: entry.name.split('/').pop(),
                  duration: Math.round(entry.duration)
                });
              }
            });
          });
          observer.observe({ entryTypes: ['resource'] });
          logBoot('PerformanceObserver activ√©');
        } catch(e) {
          logBoot('PerformanceObserver non disponible: ' + e.message);
        }
        
        // Early error logging
        logBoot('Configuration error handlers');
        
        // üîç PHASE 1: Intercepter les erreurs de chargement de scripts
        window.addEventListener('error', function(e){
          if (e.target && e.target.tagName === 'SCRIPT') {
            var scriptError = '[SCRIPT FAILED] ' + (e.target.src || '(inline)');
            console.error(scriptError);
            logBoot(scriptError);
          }
          
          var msg = '[Error] ' + e.message + ' at ' + e.filename + ':' + e.lineno;
          console.error(msg);
          logBoot(msg);
          
          if (!isPreviewMode) {
            try {
              var logs = JSON.parse(safeLocalStorageGet('calmi_early_errors') || '[]');
              logs.push({t:Date.now(),m:e.message,f:e.filename,l:e.lineno});
              if (logs.length > 10) logs = logs.slice(-10);
              safeLocalStorageSet('calmi_early_errors',JSON.stringify(logs));
            } catch(err){}
          }
        });
        
        window.addEventListener('unhandledrejection', function(e){
          var msg = '[Promise Rejection] ' + (e.reason?.message || e.reason);
          console.error(msg);
          logBoot(msg);
          
          if (!isPreviewMode) {
            try {
              var logs = JSON.parse(safeLocalStorageGet('calmi_early_errors') || '[]');
              logs.push({t:Date.now(),m:'Unhandled Promise: '+(e.reason?.message||e.reason)});
              if (logs.length > 10) logs = logs.slice(-10);
              safeLocalStorageSet('calmi_early_errors',JSON.stringify(logs));
            } catch(err){}
          }
        });
        
        // Marquer boot OK quand le DOM est compl√®tement charg√©
        window.addEventListener('load', function(){
          logBoot('DOM compl√®tement charg√©');
          console.log('‚úÖ [Boot] DOM loaded - boot OK');
          if (!isPreviewMode) {
            safeLocalStorageSet('calmi_boot_ok', 'true');
          }
        });
        
        // PHASE 4: TIMEOUT D'URGENCE ADAPTATIF
        // - 30s pour mobile r√©el (connexions instables)
        // - 20s pour mobile preview (Lovable iframe)
        // - 10s pour desktop (connexions rapides)
        var timeoutDuration = isPreviewMode ? 20000 : (isMobile ? 30000 : 10000);
        var bootStartTime = Date.now();
        
        logBoot('Configuration timeout: ' + (timeoutDuration/1000) + 's');
        console.log('[Boot] Emergency timeout configur√©:', timeoutDuration/1000 + 's', isPreviewMode ? '(Mobile Preview)' : '(Desktop)');
        
        // üîç PHASE 1: V√©rifier √©tat de React/ReactDOM toutes les 500ms
        var reactCheckInterval = setInterval(function() {
          var reactStatus = typeof window.React !== 'undefined';
          var reactDOMStatus = typeof window.ReactDOM !== 'undefined';
          
          if (reactStatus || reactDOMStatus) {
            logBoot('‚úÖ React d√©tect√©: React=' + reactStatus + ', ReactDOM=' + reactDOMStatus);
            if (reactStatus && window.React.version) {
              logBoot('React version: ' + window.React.version);
            }
            clearInterval(reactCheckInterval);
          }
        }, 500);
        
        setTimeout(function(){
          var loader = document.getElementById('emergency-loader');
          if (loader && loader.style.display !== 'none') {
            var elapsed = Math.round((Date.now() - bootStartTime) / 1000);
            logBoot('TIMEOUT atteint apr√®s ' + elapsed + 's');
            console.error('‚ùå [Emergency] React n\'a pas mont√© dans les ' + elapsed + ' secondes');
            
            // Afficher message d'erreur avec diagnostic
            var spinner = document.querySelector('.emergency-spinner');
            var errorDiv = document.querySelector('.emergency-error');
            
            if (spinner) spinner.style.display = 'none';
            if (errorDiv) {
              errorDiv.style.display = 'block';
              
              // üîç PHASE 1: Corriger le mode affich√©
              var modeInfo = isMobile ? (inIframe ? 'Mobile Preview' : 'Mobile Production') : 'Desktop';
              var hasDemo = window.location.search.indexOf('demo=1') === -1;
              
              // üîç PHASE 1: Arr√™ter l'interval de check React
              clearInterval(reactCheckInterval);
              
              // PHASE 6: Afficher les derniers logs
              var lastLogs = bootLogs.slice(-10);
              var logsHtml = '<div style="margin-top:1rem;padding:0.75rem;background:rgba(0,0,0,0.1);border-radius:4px;font-size:0.75rem;text-align:left;max-height:150px;overflow-y:auto;">';
              logsHtml += '<strong>Derniers logs:</strong><br>';
              lastLogs.forEach(function(log){
                logsHtml += '‚Ä¢ ' + log.msg + '<br>';
              });
              logsHtml += '</div>';
              
              // PHASE 3: Afficher les scripts charg√©s
              if (scriptsLoading.length > 0) {
                logsHtml += '<div style="margin-top:0.5rem;padding:0.5rem;background:rgba(255,165,0,0.1);border-radius:4px;font-size:0.7rem;">';
                logsHtml += '<strong>Scripts charg√©s (' + scriptsLoading.length + '):</strong><br>';
                var lastScripts = scriptsLoading.slice(-5);
                lastScripts.forEach(function(s){
                  logsHtml += '‚Ä¢ ' + s.name + ' (' + s.duration + 'ms)<br>';
                });
                logsHtml += '</div>';
              }
              
              // üîç PHASE 1: Lister TOUS les scripts du DOM
              var allScripts = document.querySelectorAll('script');
              logsHtml += '<div style="margin-top:0.5rem;padding:0.5rem;background:rgba(100,100,255,0.1);border-radius:4px;font-size:0.7rem;">';
              logsHtml += '<strong>Scripts dans le DOM (' + allScripts.length + '):</strong><br>';
              for (var i = 0; i < allScripts.length; i++) {
                var scriptSrc = allScripts[i].src || '(inline)';
                var scriptName = scriptSrc.split('/').pop() || '(inline-' + i + ')';
                logsHtml += '‚Ä¢ ' + scriptName + '<br>';
              }
              logsHtml += '</div>';
              
              // üîç PHASE 1: √âtat de React au timeout
              var reactStatusAtTimeout = typeof window.React !== 'undefined';
              var reactDOMStatusAtTimeout = typeof window.ReactDOM !== 'undefined';
              logsHtml += '<div style="margin-top:0.5rem;padding:0.5rem;background:rgba(255,0,0,0.1);border-radius:4px;font-size:0.7rem;">';
              logsHtml += '<strong>√âtat au timeout:</strong><br>';
              logsHtml += '‚Ä¢ window.React: ' + reactStatusAtTimeout + '<br>';
              logsHtml += '‚Ä¢ window.ReactDOM: ' + reactDOMStatusAtTimeout + '<br>';
              if (reactStatusAtTimeout && window.React.version) {
                logsHtml += '‚Ä¢ React.version: ' + window.React.version + '<br>';
              }
              logsHtml += '</div>';
              
              errorDiv.innerHTML = '<p><strong>üîç Diagnostic de chargement</strong></p>' +
                '<p style="font-size:0.9rem;margin-top:0.5rem;">L\'application ne r√©pond pas.</p>' +
                '<div class="emergency-info">Mode: ' + modeInfo + ' | Temps √©coul√©: ' + elapsed + 's</div>' +
                logsHtml +
                '<button class="emergency-btn" onclick="window.location.href=\'/?force-clean=1\'">Forcer le rechargement</button>' +
                '<button class="emergency-btn-secondary" onclick="window.location.href=\'/?safe-mode=1\'">üõ°Ô∏è Mode sans th√®me</button>' +
                (hasDemo ? '<button class="emergency-btn-secondary" onclick="window.location.href=\'/?demo=1\'">üé≠ Mode d√©mo</button>' : '');
            }
          }
        }, timeoutDuration);
      })();
    </script>
    
  
  
  
  <meta name="twitter:card" content="summary_large_image">
  <meta property="og:type" content="website">
  <meta property="og:title" content="Calmi">
  <meta name="twitter:title" content="Calmi">
  <meta property="og:description" content="Calmi - Histoires personnalis√©es pour enfants">
  <meta name="twitter:description" content="Calmi - Histoires personnalis√©es pour enfants">
</head>
  <body>
    <!-- PHASE 2: Emergency Loader - Visible par d√©faut -->
    <div id="emergency-loader">
      <div id="emergency-content">
        <div class="emergency-spinner"></div>
        <div style="font-size:1.2rem;font-weight:500;">Chargement de Calmi...</div>
        <div style="font-size:0.9rem;margin-top:0.5rem;opacity:0.8;">‚ú® Pr√©paration de vos histoires</div>
        <div class="emergency-error"></div>
      </div>
    </div>
    
    <div id="root"></div>
    <div id="calmi-boot-stamp" style="display:none;"></div>
    <script>
      // Injecter BUILD_ID dans le DOM pour recovery.js
      (function(){
        var stamp = document.getElementById('calmi-boot-stamp');
        try {
          var buildId = localStorage.getItem('calmi_build_id') || 'UNKNOWN';
          if (stamp) stamp.textContent = buildId;
          console.log('[Boot] Stage: DOM Ready, BUILD_ID:', buildId);
        } catch(e) {
          if (stamp) stamp.textContent = 'UNKNOWN';
        }
      })();
    </script>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
