<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>calmiverse-tale-weaver</title>
    <meta name="description" content="Lovable Generated Project" />
    <meta name="author" content="Lovable" />
    <meta property="og:image" content="/og-image.png" />
  </head>
  <body>
    <div id="root"></div>
    <script>
      // Configuration de base avec gestion des erreurs améliorée
      window.gptengineer = {
        config: {
          debug: false,
          retryDelay: 2000,
          maxRetries: 5,
          errorHandling: {
            ignorePatterns: [
              'cors',
              'feature',
              'ambient-light-sensor',
              'battery',
              'connection',
              'preload',
              'as',
              'link preloaded',
              'postMessage',
              'ResizeObserver loop'
            ]
          }
        }
      };

      // Fonction de sérialisation sécurisée des erreurs
      function serializeError(error) {
        if (!error) return null;
        
        const serialized = {
          message: error.message || 'Unknown error',
          name: error.name || 'Error',
          stack: error.stack,
        };

        // Nettoyer les propriétés circulaires ou non-sérialisables
        return JSON.parse(JSON.stringify(serialized, (key, value) => {
          if (value instanceof Error) {
            return serializeError(value);
          }
          if (value instanceof Request || value instanceof Response) {
            return `[${value.constructor.name}]`;
          }
          return value;
        }));
      }

      // Gestionnaire d'erreurs optimisé avec sérialisation
      const errorHandler = {
        handle(error, source) {
          try {
            // Ignorer les erreurs non critiques définies dans la config
            if (this.isNonCritical(error)) {
              return false;
            }
            
            // Sérialiser l'erreur avant le logging
            const serializedError = serializeError(error);
            console.error(`[${source}] Critical error:`, serializedError);
            return true;
          } catch (e) {
            // En cas d'erreur pendant la gestion, retourner une version simplifiée
            console.error('Error handling failed:', e.message);
            return false;
          }
        },

        isNonCritical(error) {
          try {
            const { ignorePatterns } = window.gptengineer.config.errorHandling;
            const errorMessage = (error?.message || '').toLowerCase();
            return ignorePatterns.some(pattern => errorMessage.includes(pattern));
          } catch {
            return true; // En cas de doute, traiter comme non critique
          }
        }
      };

      // Gestionnaire d'erreurs global avec debounce renforcé
      let errorTimeout;
      window.addEventListener('error', function(event) {
        if (event.target && (event.target.tagName === 'LINK' || event.target.tagName === 'SCRIPT')) {
          return false;
        }
        
        if (errorTimeout) {
          clearTimeout(errorTimeout);
        }

        errorTimeout = setTimeout(() => {
          try {
            const shouldPropagate = errorHandler.handle(event.error, 'Global Error');
            if (!shouldPropagate) {
              event.preventDefault();
            }
          } catch {
            event.preventDefault();
          }
        }, 200);
        
        return false;
      }, true);

      // Gestionnaire de promesses rejetées avec debounce renforcé
      let rejectionTimeout;
      window.addEventListener('unhandledrejection', function(event) {
        if (rejectionTimeout) {
          clearTimeout(rejectionTimeout);
        }

        rejectionTimeout = setTimeout(() => {
          try {
            const shouldPropagate = errorHandler.handle(event.reason, 'Unhandled Promise');
            if (!shouldPropagate) {
              event.preventDefault();
            }
          } catch {
            event.preventDefault();
          }
        }, 200);
        
        return false;
      });

      // Initialisation sécurisée de l'application
      window.addEventListener('load', function() {
        console.log('Application initialized safely');
      });
    </script>
    <script src="https://cdn.gpteng.co/gptengineer.js" type="module"></script>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>